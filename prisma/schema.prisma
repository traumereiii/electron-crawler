// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/main/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Stock {
  code          String
  sessionId     String
  collectTaskId String
  name          String
  price         Int
  volume        BigInt // 거래량
  tradingValue  BigInt // 거래대금
  marketCap     BigInt // 시가총액
  per           Decimal
  eps           Decimal
  pbr           Decimal
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  session     CollectSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  collectTask CollectTask    @relation(fields: [collectTaskId], references: [id], onDelete: Cascade)

  @@id([code, sessionId])
  @@index([sessionId])
  @@index([collectTaskId])
}

enum TabTaskErrorType {
  NAVIGATION_ERROR
  TASK_ERROR
  ON_SUCCESS_ERROR
}

enum CollectSessionStatus {
  IN_PROGRESS
  COMPLETED
  TERMINATED
  FAILED
}

model CollectSession {
  id           String               @id
  entryUrl     String
  totalTasks   Int
  successTasks Int
  failedTasks  Int
  startedAt    DateTime
  finishedAt   DateTime?
  status       CollectSessionStatus

  tasks      CollectTask[]
  stocks     Stock[]
  executions ScheduleExecution[]

  @@index([status])
  @@index([startedAt])
}

model CollectTask {
  id                            String            @id
  sessionId                     String
  parentId                      String?
  url                           String
  success                       Boolean
  screenshot                    String?
  startedAt                     DateTime
  spentTimeOnNavigateInMillis   Int
  spentTimeOnPageLoadedInMillis Int
  error                         String?
  errorType                     TabTaskErrorType?

  session  CollectSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parsings Parsing[]
  stocks   Stock[]

  @@index([sessionId])
  @@index([parentId])
  @@index([success])
}

model Parsing {
  id            String   @id
  collectTaskId String
  url           String
  html          String
  success       Boolean
  error         String?
  errorType     String?
  createdAt     DateTime

  collectTask CollectTask @relation(fields: [collectTaskId], references: [id], onDelete: Cascade)

  @@index([collectTaskId])
  @@index([success])
}

enum ScheduleType {
  DAILY
  WEEKLY
  MONTHLY
  CRON
}

enum ExecutionStatus {
  RUNNING
  COMPLETED
  FAILED
}

model CrawlerSchedule {
  id             String       @id @default(uuid())
  name           String
  type           ScheduleType
  cronExpression String?
  time           String
  weekdays       String? // JSON 배열: [0,1,2,3,4,5,6] (일~토)
  dayOfMonth     Int? // 1~31
  enabled        Boolean      @default(true)
  postActions    String // JSON: PostActions
  nextRunAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  executions ScheduleExecution[]

  @@index([enabled])
  @@index([nextRunAt])
}

model ScheduleExecution {
  id           String          @id @default(uuid())
  scheduleId   String
  sessionId    String?
  status       ExecutionStatus
  totalTasks   Int             @default(0)
  successTasks Int             @default(0)
  failedTasks  Int             @default(0)
  error        String?
  startedAt    DateTime
  endedAt      DateTime?

  schedule CrawlerSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  session  CollectSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([scheduleId])
  @@index([sessionId])
  @@index([status])
  @@index([startedAt])
}
